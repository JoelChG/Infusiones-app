<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Infusiones</title>

  <style>
    :root{
      /* Coolors palette */
      --bg: #4F6D7A;      /* background principal */
      --text: #DBE9EE;    /* texto principal */
      --muted: #C0D6DF;   /* texto secundario/bordes */
      --primary: #4A6FA5; /* botón primario / activo */
      --accent: #166088;  /* focus / acentos */

      /* UI tokens */
      --card: rgba(219,233,238,0.08);
      --card2: rgba(219,233,238,0.06);
      --border: rgba(192,214,223,0.35);
      --border2: rgba(192,214,223,0.25);
      --input-bg: rgba(219,233,238,0.06);
      --shadow: 0 10px 30px rgba(0,0,0,0.15);
      --radius: 14px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }

    h1{ font-size: 20px; margin: 8px 0 10px; }
    h2{ font-size: 16px; margin: 16px 0 10px; color: var(--text); opacity: 0.95; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 760px){ .grid-3{ grid-template-columns: 1fr 1fr 1fr; } }
    @media (min-width: 760px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    label{ display:block; font-size: 12px; color: rgba(192,214,223,0.95); margin-bottom: 6px; }

    input, select, button{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: rgba(192,214,223,0.65); }

    input:focus, select:focus{
      border-color: rgba(22,96,136,0.85);
      box-shadow: 0 0 0 3px rgba(22,96,136,0.25);
    }

    button{
      cursor:pointer;
      border-color: rgba(74,111,165,0.9);
      background: rgba(74,111,165,0.35);
    }
    button:hover{ background: rgba(74,111,165,0.5); }

    .ghost{
      background: transparent;
      border-color: var(--border2);
    }
    .ghost:hover{ background: rgba(219,233,238,0.08); }

    .row{ display:flex; gap:10px; align-items:end; }
    .row > *{ flex:1; }

    .muted{ color: rgba(192,214,223,0.95); font-size: 12px; line-height: 1.35; }
    .danger{ color: #ffd1d1; font-size: 12px; }

    .list{ display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }

    .item{
      border:1px solid var(--border2);
      border-radius: var(--radius);
      padding: 12px;
      background: var(--card2);
    }

    /* Header within cards (keep simple, no absolute) */
    .itemTop{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .itemName{ font-weight: 650; }

    .pill{
      font-size: 12px;
      color: var(--text);
      background: rgba(219,233,238,0.07);
      border: 1px solid var(--border2);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .seg button{ border:0; border-radius:0; background: transparent; }
    .seg button.active{ background: rgba(74,111,165,0.45); }

    .result{
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(219,233,238,0.06);
    }
    .result strong{ font-size: 14px; }
    .tiny{ font-size: 11px; color: rgba(192,214,223,0.9); }

    /* ===== FIX: robust Grid layout for "Infusiones agregadas" cards ===== */
    .infCard{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: start;
    }
    .infLeft{
      min-width: 0; /* allow wrap */
    }
    .infMeta{
      margin-top: 4px;
      color: rgba(192,214,223,0.95);
      font-size: 12px;
      line-height: 1.3;
    }
    .infConc{
      margin-top: 6px;
      white-space: normal;
      overflow-wrap: anywhere;
      line-height: 1.25;
    }
    .infRight{
      display:flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }
    .infRight .pill{
      flex-shrink: 0;
      min-width: 72px;
      text-align: right;
    }
    .infRight button{
      width: auto;
      padding: 8px 10px;
      flex-shrink: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Calculadora de Infusiones</h1>

    <div class="card">
      <h2>1) Paciente e infusiones</h2>

      <!-- Instrucciones puntuales (Preparación) -->
      <div class="muted">
        <div><b>Nombre del medicamento.</b></div>
        <div><b>Medicamento (mg):</b> cantidad total en la mezcla.</div>
        <div><b>Volumen total (mL):</b> volumen final.</div>
        <div><b>“Agregar infusión”.</b></div>
        <div>Se muestra concentración en <b>mg/mL</b> y <b>mcg/mL</b>.</div>
        <div>Se guarda localmente.</div>
      </div>

      <div class="grid grid-3" style="margin-top:10px;">
        <div>
          <label>Peso del paciente (kg)</label>
          <input id="weightKg" inputmode="decimal" placeholder="Ej. 70" />
          <div id="weightErr" class="danger" style="display:none; margin-top:6px;"></div>
        </div>
        <div>
          <label>Nombre del medicamento</label>
          <input id="drugName" placeholder="Ej. Norepinefrina" />
        </div>
        <div>
          <label>Preparación</label>
          <div class="row">
            <div>
              <label class="tiny">Medicamento (mg)</label>
              <input id="drugMg" inputmode="decimal" placeholder="Ej. 8" />
            </div>
            <div>
              <label class="tiny">Volumen total (mL)</label>
              <input id="totalMl" inputmode="decimal" placeholder="Ej. 50" />
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="muted"></div>
        <div style="flex:0.6;">
          <button id="addBtn">Agregar infusión</button>
        </div>
      </div>

      <div id="addErr" class="danger" style="display:none; margin-top:10px;"></div>

      <div style="margin-top:14px;">
        <div class="itemTop">
          <div class="muted">Infusiones agregadas</div>
          <div>
            <button class="ghost" id="clearBtn" title="Borra todas las infusiones">Limpiar todo</button>
          </div>
        </div>
        <div id="infusionList" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>2) Calculadora</h2>

      <!-- Instrucciones puntuales (Calculadora) -->
      <div class="muted">
        <div><b>“Velocidad actual → Dosis”:</b> tienes mL/h.</div>
        <div><b>“Dosis deseada → Velocidad”:</b> tienes dosis objetivo.</div>
        <div>Selecciona infusión + peso (kg) + dato del modo.</div>
      </div>

      <div class="row" style="align-items:center; margin-top:10px;">
        <div class="muted">Modo</div>
        <div class="seg" style="max-width:520px;">
          <button id="modeRate" class="active" type="button">Velocidad actual → Dosis</button>
          <button id="modeDose" type="button">Dosis deseada → Velocidad</button>
        </div>
      </div>

      <div id="calcList" class="list" style="margin-top:12px;"></div>
    </div>

    <!-- Nota (copy) -->
    <div class="muted" style="margin-top:14px;">
      <b>Nota:</b> Si cambias la mezcla, crea otra infusión.
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function toNum(v) {
    if (v === null || v === undefined) return NaN;
    const s = String(v).replace(",", ".").trim();
    if (!s) return NaN;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  // Redondeo: entero si no hay decimales; si hay, 2 decimales
  function fmtSmart(n) {
    if (!Number.isFinite(n)) return "—";
    const r = Math.round(n);
    if (Math.abs(n - r) < 1e-10) return String(r);
    return n.toFixed(2);
  }

  function saveState() {
    localStorage.setItem("inf_calc_state_v3", JSON.stringify(state));
  }

  function loadState() {
    try {
      const raw = localStorage.getItem("inf_calc_state_v3");
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === "object") state = obj;
    } catch {}
  }

  let state = {
    weightKg: "",
    mode: "rate",
    infusions: []
  };

  loadState();

  const RATE_OUT_UNITS = [
    { value: "mg_h", label: "mg/h" },
    { value: "mcg_h", label: "mcg/h" },
    { value: "mg_kg_h", label: "mg/kg/h" },
    { value: "mcg_kg_h", label: "mcg/kg/h" },
    { value: "mcg_kg_min", label: "mcg/kg/min" },
  ];

  const DESIRED_UNITS = [
    { value: "mg_h", label: "mg/h" },
    { value: "mcg_h", label: "mcg/h" },
    { value: "mg_kg_h", label: "mg/kg/h" },
    { value: "mcg_kg_h", label: "mcg/kg/h" },
    { value: "mcg_kg_min", label: "mcg/kg/min" },
  ];

  function labelFor(unit) {
    const all = [...RATE_OUT_UNITS, ...DESIRED_UNITS];
    return (all.find(x => x.value === unit) || {}).label || unit;
  }

  function getConcMgMl(inf) {
    const mg = toNum(inf.drugMg);
    const ml = toNum(inf.totalMl);
    if (!(mg > 0) || !(ml > 0)) return NaN;
    return mg / ml;
  }

  function calcDoseFromRate({ W, C, R, outUnit }) {
    const mg_h = R * C;
    const mcg_h = mg_h * 1000;
    const mg_kg_h = mg_h / W;
    const mcg_kg_h = mcg_h / W;
    const mcg_kg_min = mcg_kg_h / 60;

    switch (outUnit) {
      case "mg_h": return mg_h;
      case "mcg_h": return mcg_h;
      case "mg_kg_h": return mg_kg_h;
      case "mcg_kg_h": return mcg_kg_h;
      case "mcg_kg_min": return mcg_kg_min;
      default: return NaN;
    }
  }

  function desiredToMgH({ x, unit, W }) {
    switch (unit) {
      case "mg_h": return x;
      case "mcg_h": return x / 1000;
      case "mg_kg_h": return x * W;
      case "mcg_kg_h": return (x * W) / 1000;
      case "mcg_kg_min": return (x * W * 60) / 1000;
      default: return NaN;
    }
  }

  function calcRateFromDesired({ W, C, x, unit }) {
    const mg_h = desiredToMgH({ x, unit, W });
    return mg_h / C; // mL/h
  }

  function validateWeight(show=true) {
    const W = toNum(state.weightKg);
    const ok = (W > 0);
    const el = $("weightErr");
    if (show && !ok) {
      el.style.display = "block";
      el.textContent = "Ingresa un peso válido (> 0).";
    } else {
      el.style.display = "none";
      el.textContent = "";
    }
    return ok ? W : NaN;
  }

  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }
  function escapeAttr(str) {
    return escapeHtml(str).replace(/"/g, "&quot;");
  }

  function renderInfusionList() {
    const list = $("infusionList");
    list.innerHTML = "";

    if (!state.infusions.length) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "Aún no agregas infusiones.";
      list.appendChild(empty);
      return;
    }

    state.infusions.forEach((inf) => {
      const C = getConcMgMl(inf);
      const Cmcg = Number.isFinite(C) ? C * 1000 : NaN;

      const div = document.createElement("div");
      div.className = "item";

      // GRID robusto para evitar encimados
      div.innerHTML = `
        <div class="infCard">
          <div class="infLeft">
            <div class="itemName">${escapeHtml(inf.name || "Sin nombre")}</div>
            <div class="infMeta">
              Preparación: ${escapeHtml(inf.drugMg)} mg en ${escapeHtml(inf.totalMl)} mL
            </div>
            <div class="infMeta infConc">
              <span class="pill">
                ${Number.isFinite(C) ? `${fmtSmart(C)} mg/mL • ${fmtSmart(Cmcg)} mcg/mL` : "conc. inválida"}
              </span>
            </div>
          </div>

          <div class="infRight">
            <!-- pill numérica opcional (placeholder para “valor” si luego lo quieres).
                 Por ahora lo dejamos como concisa “OK” para mantener columna estable.
                 Si no lo quieres, dime y lo quitamos. -->
            <span class="pill" title="Estado">OK</span>
            <button class="ghost" type="button" data-del="${inf.id}">Eliminar</button>
          </div>
        </div>
      `;

      list.appendChild(div);
    });

    list.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        state.infusions = state.infusions.filter(x => x.id !== id);
        saveState();
        renderAll();
      });
    });
  }

  // Actualiza resultados SIN re-render para no perder el foco en inputs
  function updateResultForInfusion(id) {
    const inf = state.infusions.find(x => x.id === id);
    if (!inf) return;

    const W = validateWeight(false);
    const C = getConcMgMl(inf);
    const Cmcg = Number.isFinite(C) ? C * 1000 : NaN;

    const concEl = document.querySelector(`[data-conc="${id}"]`);
    if (concEl) {
      concEl.textContent = Number.isFinite(C)
        ? `${fmtSmart(C)} mg/mL · ${fmtSmart(Cmcg)} mcg/mL`
        : "—";
    }

    const mainEl = document.querySelector(`[data-main="${id}"]`);
    const subEl  = document.querySelector(`[data-sub="${id}"]`);
    const warnEl = document.querySelector(`[data-warn="${id}"]`);

    let mainLine = "—";
    let subLine = "";
    let warn = "";

    if (!(Number.isFinite(W) && W > 0)) {
      warn = "Falta peso del paciente.";
    } else if (!(Number.isFinite(C) && C > 0)) {
      warn = "Concentración inválida (mg/mL).";
    } else if (state.mode === "rate") {
      const R = toNum(inf.rateMlH);
      if (R >= 0 && String(inf.rateMlH).trim() !== "") {
        const val = calcDoseFromRate({ W, C, R, outUnit: inf.rateOutUnit });
        mainLine = `${fmtSmart(val)} ${labelFor(inf.rateOutUnit)}`;
        subLine = `(${fmtSmart(R)} mL/h · ${fmtSmart(C)} mg/mL)`;
      } else {
        warn = "Ingresa una velocidad (mL/h).";
      }
    } else {
      const x = toNum(inf.desiredDose);
      if (x >= 0 && String(inf.desiredDose).trim() !== "") {
        const R = calcRateFromDesired({ W, C, x, unit: inf.desiredUnit });
        mainLine = `${fmtSmart(R)} mL/h`;
        subLine = `para ${fmtSmart(x)} ${labelFor(inf.desiredUnit)} con ${fmtSmart(C)} mg/mL`;
      } else {
        warn = "Ingresa una dosis deseada.";
      }
    }

    if (mainEl) mainEl.textContent = mainLine;
    if (subEl) subEl.textContent = subLine;

    if (warnEl) {
      if (warn) {
        warnEl.style.display = "block";
        warnEl.textContent = warn;
      } else {
        warnEl.style.display = "none";
        warnEl.textContent = "";
      }
    }
  }

  function renderCalcList() {
    const list = $("calcList");
    list.innerHTML = "";

    if (!state.infusions.length) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "Agrega infusiones arriba para calcular.";
      list.appendChild(empty);
      return;
    }

    state.infusions.forEach((inf) => {
      const div = document.createElement("div");
      div.className = "item";

      const isRateMode = state.mode === "rate";
      const C = getConcMgMl(inf);
      const Cmcg = Number.isFinite(C) ? C * 1000 : NaN;

      const rateMlH = (inf.rateMlH ?? "");
      const outUnit = (inf.rateOutUnit ?? "mcg_kg_min");

      const desiredDose = (inf.desiredDose ?? "");
      const desiredUnit = (inf.desiredUnit ?? "mcg_kg_min");

      div.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemName">${escapeHtml(inf.name || "Sin nombre")}</div>
            <div class="muted" style="margin-top:6px;">
              Conc:
              <span class="pill" data-conc="${inf.id}">
                ${Number.isFinite(C) ? `${fmtSmart(C)} mg/mL · ${fmtSmart(Cmcg)} mcg/mL` : "—"}
              </span>
            </div>
          </div>
          <div class="pill">${isRateMode ? "Velocidad → Dosis" : "Dosis → Velocidad"}</div>
        </div>

        ${isRateMode ? `
          <div class="grid grid-2" style="margin-top:10px;">
            <div>
              <label>Velocidad actual (mL/h)</label>
              <input inputmode="decimal" value="${escapeAttr(rateMlH)}" data-rate="${inf.id}" placeholder="Ej. 12" />
            </div>
            <div>
              <label>Mostrar resultado en</label>
              <select data-outunit="${inf.id}">
                ${RATE_OUT_UNITS.map(u => `
                  <option value="${u.value}" ${u.value === outUnit ? "selected" : ""}>${u.label}</option>
                `).join("")}
              </select>
            </div>
          </div>
        ` : `
          <div class="grid grid-2" style="margin-top:10px;">
            <div>
              <label>Dosis deseada</label>
              <input inputmode="decimal" value="${escapeAttr(desiredDose)}" data-dose="${inf.id}" placeholder="Ej. 0.1" />
            </div>
            <div>
              <label>Unidad</label>
              <select data-desunit="${inf.id}">
                ${DESIRED_UNITS.map(u => `
                  <option value="${u.value}" ${u.value === desiredUnit ? "selected" : ""}>${u.label}</option>
                `).join("")}
              </select>
            </div>
          </div>
        `}

        <div class="result">
          <strong data-main="${inf.id}">—</strong>
          <div class="tiny" data-sub="${inf.id}"></div>
          <div class="danger" data-warn="${inf.id}" style="margin-top:6px; display:none;"></div>
        </div>
      `;

      list.appendChild(div);

      // Bind inputs/selects SIN re-render (no pierde foco)
      const rateInp = div.querySelector(`input[data-rate="${inf.id}"]`);
      if (rateInp) {
        rateInp.addEventListener("input", () => {
          inf.rateMlH = rateInp.value;
          saveState();
          updateResultForInfusion(inf.id);
        });
      }

      const outSel = div.querySelector(`select[data-outunit="${inf.id}"]`);
      if (outSel) {
        outSel.addEventListener("change", () => {
          inf.rateOutUnit = outSel.value;
          saveState();
          updateResultForInfusion(inf.id);
        });
      }

      const doseInp = div.querySelector(`input[data-dose="${inf.id}"]`);
      if (doseInp) {
        doseInp.addEventListener("input", () => {
          inf.desiredDose = doseInp.value;
          saveState();
          updateResultForInfusion(inf.id);
        });
      }

      const desSel = div.querySelector(`select[data-desunit="${inf.id}"]`);
      if (desSel) {
        desSel.addEventListener("change", () => {
          inf.desiredUnit = desSel.value;
          saveState();
          updateResultForInfusion(inf.id);
        });
      }

      updateResultForInfusion(inf.id);
    });
  }

  function renderAll() {
    $("weightKg").value = state.weightKg ?? "";
    renderInfusionList();
    renderCalcList();
  }

  $("weightKg").addEventListener("input", (e) => {
    state.weightKg = e.target.value;
    saveState();
    state.infusions.forEach(inf => updateResultForInfusion(inf.id));
  });

  $("addBtn").addEventListener("click", () => {
    const err = $("addErr");
    err.style.display = "none";
    err.textContent = "";

    state.weightKg = $("weightKg").value;

    const name = $("drugName").value.trim();
    const drugMg = $("drugMg").value.trim();
    const totalMl = $("totalMl").value.trim();

    const mg = toNum(drugMg);
    const ml = toNum(totalMl);

    validateWeight(true); // solo feedback

    if (!name.length) {
      err.style.display = "block";
      err.textContent = "Pon el nombre del medicamento.";
      return;
    }
    if (!(mg > 0) || !(ml > 0)) {
      err.style.display = "block";
      err.textContent = "La preparación debe ser válida: mg > 0 y mL > 0.";
      return;
    }

    state.infusions.unshift({
      id: crypto.randomUUID(),
      name,
      drugMg,
      totalMl,
      rateMlH: "",
      rateOutUnit: "mcg_kg_min",
      desiredDose: "",
      desiredUnit: "mcg_kg_min",
    });

    $("drugName").value = "";
    $("drugMg").value = "";
    $("totalMl").value = "";

    saveState();
    renderAll();
  });

  $("clearBtn").addEventListener("click", () => {
    state.infusions = [];
    saveState();
    renderAll();
  });

  function setMode(mode) {
    state.mode = mode;
    $("modeRate").classList.toggle("active", mode === "rate");
    $("modeDose").classList.toggle("active", mode === "dose");
    saveState();
    renderCalcList(); // cambia inputs
  }

  $("modeRate").addEventListener("click", () => setMode("rate"));
  $("modeDose").addEventListener("click", () => setMode("dose"));

  if (state.mode === "dose") setMode("dose");
  renderAll();
</script>
</body>
</html>


